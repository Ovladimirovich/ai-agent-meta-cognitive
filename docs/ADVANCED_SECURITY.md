# Расширенная система безопасности AI-агента

## Обзор

Расширенная система безопасности включает в себя:
- Продвинутую систему rate limiting с обнаружением аномалий
- Архитектурные слои безопасности (валидация, санитизация, аудит)
- Защиту от prompt injection и XSS атак
- Комплексный мониторинг безопасности

## Архитектура системы безопасности

### 1. Продвинутый Rate Limiting

#### Основные особенности
- **Многоуровневые ограничения**: минута, час, день
- **Burst-ограничения**: защита от кратковременных всплесков запросов
- **Обнаружение аномалий**: статистический анализ паттернов запросов
- **Динамическая блокировка**: временное блокирование при подозрительной активности
- **Скользящие окна**: более точный контроль частоты запросов

#### Параметры правил
```python
@dataclass
class AdvancedRateLimitRule:
    requests_per_minute: int          # Ограничение в минуту
    requests_per_hour: int            # Ограничение в час
    requests_per_day: int             # Ограничение в день
    burst_limit: int = 10             # Максимум запросов в секунду
    anomaly_threshold: float = 2.0    # Порог аномального поведения (стандартных отклонений)
    max_concurrent_requests: int = 5  # Максимум одновременных запросов
    block_duration: int = 300         # Время блокировки при аномалии (секунды)
    sliding_window_size: int = 60     # Размер скользящего окна в секундах
```

#### Обнаружение аномалий
Система использует статистический анализ для обнаружения аномального поведения:
- Анализ интервалов между запросами
- Обнаружение необычно высокой частоты запросов
- Выявление паттернов, характерных для DDoS-атак

### 2. Валидация и санитизация входных данных

#### Защита от Prompt Injection
Система проверяет входные данные наличие потенциальных атак prompt injection:
- Обнаружение команд игнорирования инструкций
- Проверка на включение системных сообщений
- Санитизация кодовых блоков и команд

#### Защита от XSS
- Обнаружение потенциальных XSS-атак
- Санитизация HTML-контента
- Фильтрация опасных тегов и атрибутов

#### Ограничения валидации
- Максимальная длина запроса: 10,000 символов
- Максимальная глубина контекста: 10 уровней
- Максимальное количество вложенных объектов: 5

### 3. Мониторинг безопасности

#### Типы событий безопасности
- `RATE_LIMIT_EXCEEDED`: Превышение лимитов запросов
- `ANOMALY_DETECTED`: Обнаружение аномального поведения
- `SUSPICIOUS_ACTIVITY`: Подозрительная активность
- `AUTHENTICATION_BYPASS`: Попытка обхода аутентификации
- `PROMPT_INJECTION_ATTEMPT`: Попытка prompt injection
- `XSS_ATTEMPT`: Попытка XSS-атаки

#### Логирование событий
Все события безопасности логируются с деталями:
- Время события
- ID клиента
- Эндпоинт
- Подробности события
- IP-адрес и User-Agent

## Конфигурация

### Установка правил Rate Limiting

```python
from api.advanced_security import advanced_rate_limiter, AdvancedRateLimitRule

# Создание правила для агентских эндпоинтов
agent_rule = AdvancedRateLimitRule(
    requests_per_minute=30,
    requests_per_hour=500,
    requests_per_day=2000,
    burst_limit=5,
    anomaly_threshold=1.5,
    max_concurrent_requests=3,
    block_duration=600  # 10 минут
)

# Применение правила к эндпоинту
advanced_rate_limiter.set_rule("/agent/process", agent_rule)
```

### Использование валидатора

```python
from api.advanced_security import input_validator

# Валидация и санитизация запроса
sanitized_query, warnings = await input_validator.validate_and_sanitize(query, context)
if warnings:
    logger.warning(f"Security warnings: {warnings}")
```

## Middleware безопасности

Система безопасности интегрирована как middleware в FastAPI-приложение и автоматически:
- Проверяет лимиты запросов
- Валидирует и санитизирует входные данные
- Логирует события безопасности
- Блокирует подозрительные IP-адреса

## Настройка для продакшена

### Redis для распределенного rate limiting

Для использования Redis в распределенных системах:
```python
from api.advanced_security import AdvancedRateLimiter

rate_limiter = AdvancedRateLimiter(use_redis=True)
```

### Настройка логирования

Рекомендуется настроить централизованное логирование для мониторинга событий безопасности:
- ELK Stack (Elasticsearch, Logstash, Kibana)
- Graylog
- Собственная система аудита

## Лучшие практики

1. **Регулярный аудит правил**: Периодически пересматривайте и обновляйте правила rate limiting
2. **Мониторинг аномалий**: Анализируйте логи событий безопасности для выявления новых угроз
3. **Обновление паттернов**: Регулярно обновляйте паттерны обнаружения атак
4. **Тестирование безопасности**: Проводите регулярные тесты на проникновение
5. **Обучение моделей**: Используйте данные событий безопасности для обучения ML-моделей обнаружения аномалий

## Метрики безопасности

Система предоставляет следующие метрики для мониторинга:
- Количество заблокированных запросов
- Частота обнаруженных аномалий
- Количество попыток prompt injection
- Количество XSS-атак
- Эффективность rate limiting
