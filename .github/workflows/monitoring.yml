name: Pipeline Monitoring and Alerting

on:
  workflow_run:
    workflows: ["Comprehensive CI/CD Pipeline"]
    types:
      - completed

jobs:
  alert-on-failure:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Get workflow run details
      id: workflow-details
      run: |
        echo "Workflow: ${{ github.event.workflow_run.name }}"
        echo "Conclusion: ${{ github.event.workflow_run.conclusion }}"
        echo "Branch: ${{ github.event.workflow_run.head_branch }}"
        echo "Event: ${{ github.event.workflow_run.event }}"
        echo "URL: ${{ github.event.workflow_run.html_url }}"

    - name: Send Slack notification
      if: env.SLACK_WEBHOOK_URL != null
      uses: 8398a7/action-slack@v3
      with:
        status: ${{ job.status }}
        text: '❌ Pipeline failed: ${{ github.event.workflow_run.name }} on ${{ github.event.workflow_run.head_branch }}'
        webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

    - name: Send email notification
      if: env.EMAIL_HOST != null
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: ${{ secrets.EMAIL_HOST }}
        server_port: ${{ secrets.EMAIL_PORT }}
        username: ${{ secrets.EMAIL_USERNAME }}
        password: ${{ secrets.EMAIL_PASSWORD }}
        subject: '❌ Pipeline Failure Alert'
        to: ${{ secrets.ALERT_RECIPIENTS }}
        from: GitHub Actions
        html: |
          <h2>Pipeline Failure Alert</h2>
          <p><strong>Workflow:</strong> ${{ github.event.workflow_run.name }}</p>
          <p><strong>Branch:</strong> ${{ github.event.workflow_run.head_branch }}</p>
          <p><strong>Event:</strong> ${{ github.event.workflow_run.event }}</p>
          <p><strong>Status:</strong> ${{ github.event.workflow_run.conclusion }}</p>
          <p><strong>Triggered by:</strong> ${{ github.event.workflow_run.triggering_actor.login }}</p>
          <p><strong>Link:</strong> <a href="${{ github.event.workflow_run.html_url }}">View Run</a></p>
          <p><strong>Commit:</strong> <a href="https://github.com/${{ github.repository }}/commit/${{ github.event.workflow_run.head_sha }}">${{ github.event.workflow_run.head_sha }}</a></p>

  # Health check for deployed environments
  health-check:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        environment: [development, staging, production]
    continue-on-error: true
    
    steps:
    - name: Check environment health
      run: |
        # This is a placeholder - in a real implementation, you would check the actual health
        # of your deployed environments
        echo "Checking health of ${{ matrix.environment }} environment"
        
        # Example: curl health endpoint
        # curl -f http://your-${{ matrix.environment }}-env.com/health || echo "Health check failed"
        
        # For now, just simulate the check
        echo "Health check completed for ${{ matrix.environment }}"