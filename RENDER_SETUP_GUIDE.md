# Руководство по настройке Render.com для AI Агента с Мета-Познанием

Данное руководство поможет вам развернуть ваше приложение на Render.com с использованием Docker-контейнера.

## Создание веб-службы на Render.com

1. **Войдите в аккаунт Render.com**
   - Перейдите на [https://dashboard.render.com](https://dashboard.render.com)
   - Авторизуйтесь с помощью GitHub аккаунта

2. **Создайте новую веб-службу**
   - Нажмите кнопку "New +" в левом верхнем углу
   - Выберите "Web Service"
   - Выберите ваш GitHub репозиторий с проектом AI Агента с Мета-Познанием

## Настройки развертывания

### Основные настройки

- **Runtime**: Docker
- **Branch**: main
- **Region**: Oregon (US West) или любой другой по вашему выбору
- **Root Directory**: (оставьте пустым, так как у нас проект находится в корне репозитория)

### Instance Type (Тип инстанса)

Для начала рекомендуется использовать бесплатный тариф:
- **Free**: $0/месяц, 512 MB RAM, 0.1 CPU
  - Подходит для тестирования и разработки
  - Может спать при отсутствии активности (до 15 минут бездействия)

Для продакшена можно использовать:
- **Starter**: $7/месяц, 512 MB RAM, 0.5 CPU
- **Standard**: $25/месяц, 2 GB RAM, 1 CPU

### Environment Variables (Переменные окружения)

Добавьте следующие переменные окружения в раздел "Environment Variables":

```
ENVIRONMENT=production
LOG_LEVEL=INFO

# Настройки API
API_HOST=0.0.0.0
API_PORT=10000  # Render использует порт 10000 для веб-служб
API_WORKERS=1    # Для бесплатного тарифа рекомендуется 1 воркер

# Настройки базы данных (Render предоставит автоматически)
DATABASE_URL=postgresql://...  # Render автоматически создаст и предоставит

# Настройки Redis (Render предоставит автоматически)
REDIS_URL=redis://...  # Render автоматически создаст и предоставит

# Настройки безопасности (замените на сгенерированные значения)
SECRET_KEY=сгенерируйте_надежный_секретный_ключ
JWT_SECRET_KEY=сгенерируйте_надежный_jwt_секретный_ключ

# Настройки CORS (обновите согласно вашему домену GitHub Pages)
CORS_ORIGINS=["https://ваш-логин.github.io", "https://ваш-логин.github.io/ваш-репозиторий"]

# Настройки LLM API (по желанию, если планируете использовать)
OPENAI_API_KEY=ваш_openai_api_ключ
GOOGLE_AI_API_KEY=ваш_google_ai_api_ключ

# Настройки кэширования
CACHE_DEFAULT_TTL=3600
```

### Генерация SECRET_KEY

Для генерации надежного SECRET_KEY выполните команду в терминале:

```bash
python -c "import secrets; print(secrets.token_urlsafe(32))"
```

### Dockerfile

Убедитесь, что в корне вашего репозитория есть Dockerfile (уже создан в проекте):

```Dockerfile
# Используем официальный образ Python
FROM python:3.11-slim

# Устанавливаем переменные окружения
ENV PYTHONUNBUFFERED=1 \
    PYTHONDONTWRITEBYTECODE=1 \
    PIP_NO_CACHE_DIR=1 \
    PIP_DISABLE_PIP_VERSION_CHECK=1

# Устанавливаем рабочую директорию
WORKDIR /app

# Копируем файлы зависимостей
COPY requirements.txt requirements-dev.txt requirements-render.txt ./

# Устанавливаем зависимости - используем разные файлы в зависимости от среды
# По умолчанию используем основной requirements.txt
ARG REQUIREMENTS_FILE=requirements.txt
ENV REQUIREMENTS_FILE=${REQUIREMENTS_FILE}

# Устанавливаем зависимости
RUN pip install --upgrade pip && \
    pip install -r ${REQUIREMENTS_FILE}

# Копируем исходный код
COPY . .

# Устанавливаем права на выполнение для скриптов запуска
RUN chmod +x /app/run_frontend_simple.bat /app/run_frontend.bat /app/run_frontend.ps1

# Экспортируем порт, который будет использоваться
EXPOSE $PORT 8000

# Команда для запуска приложения
CMD ["sh", "-c", "uvicorn api.main:app --host=0.0.0.0 --port=${PORT:-10000} --workers ${API_WORKERS:-1}"]
```

## Настройка автоматического деплоя

Render автоматически настроит автоматический деплой с ветки `main`. При каждом пуше в ветку `main` будет происходить автоматическая пересборка и деплой приложения.

## Проверка развертывания

1. После создания веб-службы Render начнет процесс сборки
2. Следите за логами сборки в панели управления Render
3. После успешной сборки вы получите URL в формате `https://ваше-приложение.onrender.com`

## Возможные проблемы и решения

1. **Timeout ошибки**: Увеличьте время ожидания в настройках Render или оптимизируйте запуск приложения
2. **Memory ошибки**: Перейдите на более мощный тарифный план
3. **Port ошибки**: Убедитесь, что приложение слушает порт, указанный в переменной окружения `$PORT`

## Настройка домена (опционально)

Если хотите использовать кастомный домен:
1. Перейдите на вкладку "Domains" в настройках службы
2. Добавьте свой домен
3. Обновите DNS-записи согласно инструкциям Render

## Мониторинг и логирование

Render предоставляет встроенные инструменты мониторинга и логирования:
- Используйте вкладку "Logs" для просмотра логов
- Вкладка "Settings" содержит настройки мониторинга

## Безопасность

- Не храните чувствительные данные в открытом виде
- Используйте переменные окружения для API-ключей и паролей
- Регулярно обновляйте зависимости
- Используйте надежные сгенерированные ключи

## Особенности конфигурации для Render.com

### Использование специального файла зависимостей

Для успешного развертывания на Render.com создан специальный файл зависимостей `requirements-render.txt`, в котором исключены пакеты, требующие нативной компиляции (например, `llama-cpp-python`, `faiss-cpu`, `torch` и др.).

Чтобы использовать этот файл при сборке на Render.com, установите следующую переменную окружения в настройках вашей веб-службы на Render.com:

```
REQUIREMENTS_FILE=requirements-render.txt
```

Это позволит Docker-контейнеру использовать правильный набор зависимостей, совместимый с окружением Render.com.

Также рекомендуется установить переменную окружения `REQUIREMENTS_FILE` в настройках сервиса на Render.com со значением `requirements-render.txt`.
